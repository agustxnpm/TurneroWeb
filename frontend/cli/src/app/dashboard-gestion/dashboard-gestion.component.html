<div class="dashboard-gestion-container">
  <div class="card p-xl mb-xl mx-auto">
    <!-- Header del Dashboard -->
    <div class="dashboard-container">
      <div class="dashboard-header">
        <div class="header-title">
          <span class="material-symbols-outlined header-icon">analytics</span>
          <h2>Dashboard de Gestión</h2>
        </div>
      </div>

      <app-filtros-dashboard [centrosAtencion]="centrosAtencion" (aplicar)="onAplicarFiltros($event)">
      </app-filtros-dashboard>


      <!-- Loading state -->
      <div *ngIf="loading" class="loading-state">
        <div class="loading-content">
          <span class="material-symbols-outlined spinning">progress_activity</span>
          <h6>Cargando métricas...</h6>
        </div>
      </div>

      <!-- KPIs Grid -->
      <div class="kpi-grid mb-lg" *ngIf="!loading">
        <div *ngIf="metricas.totalTurnos !== undefined">
          <app-kpi-card title="Turnos totales" [value]="metricas.totalTurnos" icon="event">
          </app-kpi-card>
        </div>
        <div *ngIf="metricas.tasaAsistencia !== undefined">
          <app-kpi-card title="Tasa asistencia (%)" [value]="metricas.tasaAsistencia | number:'1.0-1'"
            icon="check_circle">
          </app-kpi-card>
        </div>
        <div *ngIf="metricas.porcentajeCancelaciones !== undefined">
          <app-kpi-card title="Cancelaciones (%)" [value]="metricas.porcentajeCancelaciones | number:'1.0-1'"
            icon="cancel">
          </app-kpi-card>
        </div>
        <div *ngIf="metricas.porcentajeAusentismo !== undefined">
          <app-kpi-card title="Ausentismo (%)" [value]="metricas.porcentajeAusentismo | number:'1.0-1'"
            icon="person_off">
          </app-kpi-card>
        </div>
      </div>

      <!-- Calidad y Satisfacción -->
      <div class="calidad-section mb-lg" *ngIf="!loading">
        <div class="section-header mb-md">
          <span class="material-symbols-outlined">thumb_up</span>
          <h6 class="mb-0">Calidad y Satisfacción</h6>
        </div>

        <div class="kpi-grid">
          <app-kpi-card title="Satisfacción promedio"
            [value]="calidad.satisfaccionPromedio ? (calidad.satisfaccionPromedio | number:'1.1-2') : '-'"
            icon="mood"></app-kpi-card>

          <app-kpi-card title="Tiempo promedio asignación (min)"
            [value]="calidad.tiempoPromedioSolicitudAsignacionMinutos ? (calidad.tiempoPromedioSolicitudAsignacionMinutos | number:'1.0-0') : '-'"
            icon="schedule"></app-kpi-card>

          <app-kpi-card title="Quejas" [value]="calidad.conteoQuejas !== undefined ? calidad.conteoQuejas : '-'"
            icon="report_problem"></app-kpi-card>

          <div class="comentarios-kpi" style="cursor:pointer" (click)="abrirComentarios()">
            <app-kpi-card title="Comentarios"
              [value]="calidad.numeroComentarios !== undefined ? calidad.numeroComentarios : '-'"
              icon="chat"></app-kpi-card>
          </div>
        </div>
      </div>

      <!-- Predictivas -->
      <div class="predictivas-section mb-lg" *ngIf="!loading">
        <div class="section-header mb-md">
          <span class="material-symbols-outlined">insights</span>
          <h6 class="mb-0">Métricas Predictivas</h6>
        </div>

        <div class="predictivas-list">
          <div *ngIf="predictivas && predictivas.length; else sinPredictivas">
            <div class="predictiva-item" *ngFor="let p of predictivas">
              <div class="predictiva-titulo">{{ p.especialidad || '-' }}</div>
              <div class="predictiva-detalle">Pendientes: {{ p.pendientes ?? 0 }} &nbsp; • &nbsp; Urgentes: {{ p.urgentes ?? 0 }}</div>
              <div class="predictiva-valor">Días promedio espera: {{ p.avgDiasEspera != null ? (p.avgDiasEspera | number:'1.0-0') : '-' }}</div>
            </div>
          </div>
          <ng-template #sinPredictivas>
            <div class="empty-state-small">
              <span class="material-symbols-outlined">info</span>
              <p>No hay datos predictivos disponibles</p>
            </div>
          </ng-template>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="charts-grid" *ngIf="!loading">
        <!-- Gráfico de torta -->
        <div class="chart-container">
          <app-grafico-torta title="Turnos por estado" [labels]="turnosLabels" [data]="turnosData" icon="pie_chart">
          </app-grafico-torta>
        </div>

        <!-- Ocupación por consultorio -->
        <div class="ocupacion-container">
          <div class="dashboard-section">
            <div class="section-header mb-md">
              <span class="material-symbols-outlined">meeting_room</span>
              <h6 class="mb-0">Ocupación por consultorio</h6>
            </div>

            <!-- Scroll container con altura máxima -->
            <div class="ocupacion-scroll-wrapper" *ngIf="ocupacionEntries && ocupacionEntries.length">
              <div class="ocupacion-list">
                <div class="ocupacion-item" *ngFor="let c of ocupacionEntries">
                  <div class="consultorio-info">
                    <span class="material-symbols-outlined">door_front</span>
                    <div class="consultorio-detalles">
                      <span class="consultorio-nombre">{{ c.consultorioNombre }}</span>
                    </div>
                  </div>
                  <div class="ocupacion-value">
                    <span class="badge-ocupacion">
                      {{ c.porcentajeOcupacion | number:'1.0-1' }}%
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Indicador de cantidad -->
            <div class="ocupacion-footer" *ngIf="ocupacionEntries && ocupacionEntries.length">
              <span class="material-symbols-outlined">info</span>
              <span>{{ ocupacionEntries.length }} consultorio{{ ocupacionEntries.length !== 1 ? 's' : '' }} registrado{{
                ocupacionEntries.length !== 1 ? 's' : '' }}</span>
            </div>

            <div class="empty-state-small" *ngIf="!ocupacionEntries || ocupacionEntries.length === 0">
              <span class="material-symbols-outlined">info</span>
              <p>No hay datos de ocupación disponibles</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>