<div class="audit-dashboard-wrapper">
  <!-- Header del Dashboard -->
  <div class="dashboard-header d-flex align-items-center justify-content-between mb-lg" role="banner">
    <div class="d-flex align-items-center gap-md">
      <span class="material-symbols-outlined" aria-hidden="true">analytics</span>
      <h2 class="mb-0">Dashboard de Auditoría</h2>
    </div>
    <div class="d-flex gap-md">
      <button type="button" 
              class="btn btn-outline-primary" 
              (click)="goToAdvancedSearch()" 
              aria-label="Ir a búsqueda avanzada de auditoría">
        <span class="material-symbols-outlined" aria-hidden="true">search</span>
        Búsqueda Avanzada
      </button>
    </div>
  </div>

  <!-- Estadísticas de Turnos -->
  <section class="stats-section">
    <h2 class="section-title">
      <span class="material-symbols-outlined">monitoring</span>
      Estadísticas de Turnos
    </h2>
    <p class="section-description">Resumen general del sistema de turnos</p>
    
    <div class="stats-grid">
      <div class="card stat-card">
        <span class="material-symbols-outlined card-icon">event_available</span>
        <div class="stat-content">
          <h3 class="stat-value">{{totalTurnos}}</h3>
          <p class="stat-label">Total Turnos</p>
        </div>
      </div>

      <div class="card stat-card stat-programado">
        <span class="material-symbols-outlined card-icon">schedule</span>
        <div class="stat-content">
          <h3 class="stat-value">{{turnosPorEstado.PROGRAMADO || 0}}</h3>
          <p class="stat-label">Programados</p>
        </div>
      </div>

      <div class="card stat-card stat-confirmado">
        <span class="material-symbols-outlined card-icon">check_circle</span>
        <div class="stat-content">
          <h3 class="stat-value">{{turnosPorEstado.CONFIRMADO || 0}}</h3>
          <p class="stat-label">Confirmados</p>
        </div>
      </div>

      <div class="card stat-card stat-completo">
        <span class="material-symbols-outlined card-icon">task_alt</span>
        <div class="stat-content">
          <h3 class="stat-value">{{turnosPorEstado.COMPLETO || 0}}</h3>
          <p class="stat-label">Completados</p>
        </div>
      </div>

      <div class="card stat-card stat-reagendado">
        <span class="material-symbols-outlined card-icon">event_repeat</span>
        <div class="stat-content">
          <h3 class="stat-value">{{turnosPorEstado.REAGENDADO || 0}}</h3>
          <p class="stat-label">Reagendados</p>
        </div>
      </div>

      <div class="card stat-card stat-cancelado">
        <span class="material-symbols-outlined card-icon">cancel</span>
        <div class="stat-content">
          <h3 class="stat-value">{{turnosPorEstado.CANCELADO || 0}}</h3>
          <p class="stat-label">Cancelados</p>
        </div>
      </div>
    </div>
  </section>


  <!-- Gráficos de Distribución -->
  <section class="charts-section">
    <h2 class="section-title">
      <span class="material-symbols-outlined">bar_chart</span>
      Distribución de Actividad
    </h2>
    <p class="section-description">Análisis de acciones y usuarios</p>
    
    <div class="charts-grid">
      <!-- Distribución de Acciones -->
      <div class="card chart-card">
        <div class="chart-header">
          <span class="material-symbols-outlined">pie_chart</span>
          <h3>Distribución de Acciones</h3>
        </div>
        <div class="chart-body">
          <div class="progress-item" *ngFor="let action of getObjectKeys(auditStatistics.porAccion)">
            <div class="progress-header">
              <span class="progress-label">
                <span class="material-symbols-outlined">{{getActionIconMaterial(action)}}</span>
                {{action}}
              </span>
              <span class="progress-value">
                {{auditStatistics.porAccion[action]}} ({{getActionPercentage(auditStatistics.porAccion[action])}}%)
              </span>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar" 
                   [class]="getProgressBarClass(action)"
                   [style.width.%]="getActionPercentage(auditStatistics.porAccion[action])">
              </div>
            </div>
          </div>
          <div class="empty-state" *ngIf="getObjectKeys(auditStatistics.porAccion).length === 0">
            <span class="material-symbols-outlined empty-icon">pie_chart</span>
            <p>No hay datos de acciones disponibles</p>
          </div>
        </div>
      </div>

      <!-- Actividad por Usuario -->
      <div class="card chart-card">
        <div class="chart-header">
          <span class="material-symbols-outlined">groups</span>
          <h3>Actividad por Usuario</h3>
        </div>
        <div class="chart-body">
          <div class="progress-item" *ngFor="let user of getObjectKeys(auditStatistics.porUsuario)">
            <div class="progress-header">
              <span class="progress-label">
                <span class="material-symbols-outlined">person</span>
                {{user}}
              </span>
              <span class="progress-value">{{auditStatistics.porUsuario[user]}} acciones</span>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar progress-bar-info"
                   [style.width.%]="(auditStatistics.porUsuario[user] / auditStatistics.totalAcciones) * 100">
              </div>
            </div>
          </div>
          <div class="empty-state" *ngIf="getObjectKeys(auditStatistics.porUsuario).length === 0">
            <span class="material-symbols-outlined empty-icon">groups</span>
            <p>No hay datos de usuarios disponibles</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Gráficos de Turnos -->
  <section class="charts-section">
    <h2 class="section-title">
      <span class="material-symbols-outlined">analytics</span>
      Análisis por Especialidad y Centro
    </h2>
    <p class="section-description">Distribución de turnos del sistema</p>
    
    <div class="charts-grid">
      <!-- Turnos por Especialidad -->
      <div class="card chart-card">
        <div class="chart-header">
          <span class="material-symbols-outlined">medical_services</span>
          <h3>Turnos por Especialidad</h3>
        </div>
        <div class="chart-body">
          <div class="progress-item" *ngFor="let especialidad of getObjectKeys(turnosPorEspecialidad)">
            <div class="progress-header">
              <span class="progress-label">
                <span class="material-symbols-outlined">stethoscope</span>
                {{especialidad}}
              </span>
              <span class="progress-value">
                {{turnosPorEspecialidad[especialidad]}} turnos ({{getTurnoPercentage(turnosPorEspecialidad[especialidad])}}%)
              </span>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar progress-bar-primary"
                   [style.width.%]="getTurnoPercentage(turnosPorEspecialidad[especialidad])">
              </div>
            </div>
          </div>
          <div class="empty-state" *ngIf="getObjectKeys(turnosPorEspecialidad).length === 0">
            <span class="material-symbols-outlined empty-icon">medical_services</span>
            <p>No hay turnos disponibles</p>
          </div>
        </div>
      </div>

      <!-- Turnos por Centro -->
      <div class="card chart-card">
        <div class="chart-header">
          <span class="material-symbols-outlined">local_hospital</span>
          <h3>Turnos por Centro</h3>
        </div>
        <div class="chart-body">
          <div class="progress-item" *ngFor="let centro of getObjectKeys(turnosPorCentro)">
            <div class="progress-header">
              <span class="progress-label">
                <span class="material-symbols-outlined">location_on</span>
                {{centro}}
              </span>
              <span class="progress-value">
                {{turnosPorCentro[centro]}} turnos ({{getTurnoPercentage(turnosPorCentro[centro])}}%)
              </span>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar progress-bar-success"
                   [style.width.%]="getTurnoPercentage(turnosPorCentro[centro])">
              </div>
            </div>
          </div>
          <div class="empty-state" *ngIf="getObjectKeys(turnosPorCentro).length === 0">
            <span class="material-symbols-outlined empty-icon">local_hospital</span>
            <p>No hay turnos disponibles</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Filtros Avanzados -->
  <section class="filters-section card mb-xl">
    <div class="section-header">
      <h2 class="section-title">
        <span class="material-symbols-outlined">filter_alt</span>
        Filtros Avanzados
      </h2>
      <p class="section-description">Refina los resultados de auditoría según tus criterios</p>
    </div>

    <div class="filters-container">
      <div class="filters-grid">
        <!-- Fecha Desde -->
        <div class="form-group mb-md">
          <label for="dateFrom" class="form-label">Fecha Desde</label>
          <input 
            type="date" 
            class="form-control" 
            id="dateFrom"
            [(ngModel)]="dateFrom" 
            (change)="applyFilters()"
            aria-label="Filtrar por fecha desde"
            placeholder="Seleccionar fecha inicial">
        </div>

        <!-- Fecha Hasta -->
        <div class="form-group mb-md">
          <label for="dateTo" class="form-label">Fecha Hasta</label>
          <input 
            type="date" 
            class="form-control" 
            id="dateTo"
            [(ngModel)]="dateTo" 
            (change)="applyFilters()"
            aria-label="Filtrar por fecha hasta"
            placeholder="Seleccionar fecha final">
        </div>

        <!-- Tipo de Acción -->
        <div class="form-group mb-md">
          <label for="actionFilter" class="form-label">Tipo de Acción</label>
          <select 
            class="form-select" 
            id="actionFilter"
            [(ngModel)]="selectedAction" 
            (change)="applyFilters()"
            aria-label="Filtrar por tipo de acción">
            <option value="">Todas las acciones</option>
            <option *ngFor="let action of availableActions" [value]="action">{{ action }}</option>
          </select>
        </div>

        <!-- Usuario -->
        <div class="form-group mb-md">
          <label for="userFilter" class="form-label">Usuario</label>
          <input 
            type="text" 
            class="form-control" 
            id="userFilter"
            [(ngModel)]="selectedUser" 
            (input)="applyFilters()"
            aria-label="Filtrar por usuario"
            placeholder="Nombre de usuario">
        </div>

        <!-- Tipo de Entidad -->
        <div class="form-group mb-md">
          <label for="entityTypeFilter" class="form-label">Tipo de Entidad</label>
          <select 
            class="form-select" 
            id="entityTypeFilter"
            [(ngModel)]="selectedEntityType" 
            (change)="applyFilters()"
            aria-label="Filtrar por tipo de entidad">
            <option value="">Todos los tipos</option>
            <option *ngFor="let entityType of availableEntityTypes" [value]="entityType">{{ entityType }}</option>
          </select>
        </div>

        <!-- Botón Limpiar Filtros -->
        <div class="form-group mb-md d-flex align-items-end">
          <button 
            type="button" 
            class="btn btn-outline-secondary w-100"
            (click)="clearFilters()" 
            aria-label="Limpiar todos los filtros">
            <span class="material-symbols-outlined" aria-hidden="true">filter_alt_off</span>
            Limpiar Filtros
          </button>
        </div>
      </div>

      <!-- Indicador de filtros activos -->
      <div class="active-filters-indicator" *ngIf="dateFrom || dateTo || selectedAction || selectedUser || selectedEntityType">
        <span class="material-symbols-outlined">info</span>
        <span>Filtros activos: 
          <strong>{{ (dateFrom ? 1 : 0) + (dateTo ? 1 : 0) + (selectedAction ? 1 : 0) + (selectedUser ? 1 : 0) + (selectedEntityType ? 1 : 0) }}</strong>
        </span>
      </div>
    </div>
  </section>

  <!-- Tabla de Logs de Auditoría -->
  <section class="audit-table-section card">
    <div class="table-header d-flex align-items-center justify-content-between p-md">
      <div class="d-flex align-items-center gap-md">
        <span class="material-symbols-outlined" aria-hidden="true">history</span>
        <h3 class="mb-0">Actividad de Auditoría</h3>
      </div>
      <div class="d-flex gap-md">
        <button type="button" 
                class="btn btn-primary btn-sm" 
                (click)="refreshData()" 
                [disabled]="loading"
                aria-label="Actualizar tabla de auditoría">
          <span class="material-symbols-outlined" [class.spinner]="loading" aria-hidden="true">autorenew</span>
          Actualizar
        </button>
        <button type="button" 
                class="btn btn-outline-primary btn-sm" 
                (click)="goToAdvancedSearch()"
                aria-label="Ir a búsqueda avanzada de auditoría">
          <span class="material-symbols-outlined" aria-hidden="true">search</span>
          Búsqueda Avanzada
        </button>
      </div>
    </div>


    <!-- Tabla de Logs -->
    <div class="table-responsive">
      <table class="table table-hover mb-0" role="table" aria-label="Tabla de logs de auditoría">
        <thead>
          <tr>
            <th scope="col" 
                class="sortable" 
                (click)="sortBy('performedAt')" 
                role="button" 
                tabindex="0"
                [attr.aria-label]="'Ordenar por fecha/hora ' + (sortField === 'performedAt' ? (sortDirection === 'asc' ? 'descendente' : 'ascendente') : 'ascendente')">
              <span class="material-symbols-outlined" aria-hidden="true">calendar_month</span>
              Fecha/Hora
              <span class="material-symbols-outlined sort-icon" aria-hidden="true" *ngIf="sortField === 'performedAt'">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </span>
            </th>
            <th scope="col" 
                class="sortable" 
                (click)="sortBy('turno.id')" 
                role="button" 
                tabindex="0"
                [attr.aria-label]="'Ordenar por ID de turno ' + (sortField === 'turno.id' ? (sortDirection === 'asc' ? 'descendente' : 'ascendente') : 'ascendente')">
              <span class="material-symbols-outlined" aria-hidden="true">tag</span>
              Turno ID
              <span class="material-symbols-outlined sort-icon" aria-hidden="true" *ngIf="sortField === 'turno.id'">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </span>
            </th>
            <th scope="col" 
                class="sortable" 
                (click)="sortBy('action')" 
                role="button" 
                tabindex="0"
                [attr.aria-label]="'Ordenar por acción ' + (sortField === 'action' ? (sortDirection === 'asc' ? 'descendente' : 'ascendente') : 'ascendente')">
              <span class="material-symbols-outlined" aria-hidden="true">bolt</span>
              Acción
              <span class="material-symbols-outlined sort-icon" aria-hidden="true" *ngIf="sortField === 'action'">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </span>
            </th>
            <th scope="col" 
                class="sortable" 
                (click)="sortBy('performedBy')" 
                role="button" 
                tabindex="0"
                [attr.aria-label]="'Ordenar por usuario ' + (sortField === 'performedBy' ? (sortDirection === 'asc' ? 'descendente' : 'ascendente') : 'ascendente')">
              <span class="material-symbols-outlined" aria-hidden="true">person</span>
              Usuario
              <span class="material-symbols-outlined sort-icon" aria-hidden="true" *ngIf="sortField === 'performedBy'">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </span>
            </th>
            <th scope="col">
              <span class="material-symbols-outlined" aria-hidden="true">history</span>
              Estado Anterior
            </th>
            <th scope="col">
              <span class="material-symbols-outlined" aria-hidden="true">update</span>
              Estado Nuevo
            </th>
            <th scope="col">
              <span class="material-symbols-outlined" aria-hidden="true">comment</span>
              Motivo
            </th>
            <th scope="col">
              <span class="material-symbols-outlined" aria-hidden="true">category</span>
              Entidad
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let log of auditLogs; trackBy: trackByLogId">
            <td class="timestamp-cell">
              <span class="material-symbols-outlined cell-icon" aria-hidden="true">schedule</span>
              <small>{{formatDateTime(log.performedAt)}}</small>
            </td>
            <td class="id-cell">
              <button type="button" 
                      class="btn btn-link btn-sm p-0"
                      (click)="goToTurnoDetail(log.entityId!)"
                      *ngIf="log.entityType === 'TURNO' && log.entityId"
                      [attr.aria-label]="'Ver detalle del turno número ' + log.entityId">
                #{{log.entityId}}
              </button>
              <span *ngIf="log.entityType !== 'TURNO' || !log.entityId" class="text-muted">N/A</span>
            </td>
            <td class="action-cell">
              <span class="badge" [ngClass]="getActionBadgeClass(log.action)">
                <span class="material-symbols-outlined badge-icon" aria-hidden="true">{{getActionIconMaterial(log.action)}}</span>
                {{log.action}}
              </span>
            </td>
            <td class="user-cell">
              <span class="material-symbols-outlined cell-icon" aria-hidden="true">person</span>
              <small *ngIf="log.performedBy">{{log.performedBy}}</small>
              <small *ngIf="!log.performedBy" class="text-muted fst-italic">Sistema</small>
            </td>
            <td class="status-cell">
              <span class="badge bg-secondary" *ngIf="log.estadoAnterior">
                <span class="material-symbols-outlined badge-icon" aria-hidden="true">history</span>
                {{log.estadoAnterior}}
              </span>
              <span class="text-muted" *ngIf="!log.estadoAnterior">-</span>
            </td>
            <td class="status-cell">
              <span class="badge bg-primary" *ngIf="log.estadoNuevo">
                <span class="material-symbols-outlined badge-icon" aria-hidden="true">check_circle</span>
                {{log.estadoNuevo}}
              </span>
              <span class="text-muted" *ngIf="!log.estadoNuevo">-</span>
            </td>
            <td class="reason-cell">
              <small [title]="log.reason || 'Sin motivo especificado'">
                {{log.reason || 'Sin motivo'}}
              </small>
            </td>
            <td class="entity-cell">
              <span class="badge bg-info">
                <span class="material-symbols-outlined badge-icon" aria-hidden="true">category</span>
                {{getEntityType(log)}}
              </span>
            </td>
          </tr>

          <!-- Sin resultados -->
          <tr *ngIf="!loading && auditLogs.length === 0">
            <td colspan="8" class="text-center">
              <div class="empty-state">
                <span class="material-symbols-outlined empty-icon" aria-hidden="true">history</span>
                <h6 class="empty-title">No hay actividad registrada</h6>
                <p class="empty-description">Intenta ajustar los filtros de búsqueda o verifica que haya actividad en el sistema.</p>
              </div>
            </td>
          </tr>

          <!-- Estado de carga -->
          <tr *ngIf="loading">
            <td colspan="8" class="text-center">
              <div class="loading-state">
                <span class="material-symbols-outlined loading-icon spin" aria-hidden="true">sync</span>
                <p class="loading-text">Cargando actividad de auditoría...</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginador -->
    <div class="pagination-section" *ngIf="auditPage && auditPage.totalPages > 1">
      <nav aria-label="Navegación de páginas de auditoría">
        <ul class="pagination mb-0">
          <!-- Anterior -->
          <li class="page-item" [class.disabled]="auditPage.first">
            <button type="button"
                    class="page-link" 
                    (click)="previousPage()" 
                    [disabled]="auditPage.first"
                    aria-label="Página anterior">
              <span class="material-symbols-outlined" aria-hidden="true">chevron_left</span>
            </button>
          </li>

          <!-- Números de página -->
          <li class="page-item" 
              *ngFor="let page of pageNumbers"
              [class.active]="page === auditPage.currentPage">
            <button type="button"
                    class="page-link" 
                    (click)="goToPage(page)"
                    [attr.aria-label]="'Ir a la página ' + (page + 1)"
                    [attr.aria-current]="page === auditPage.currentPage ? 'page' : null">
              {{page + 1}}
            </button>
          </li>

          <!-- Siguiente -->
          <li class="page-item" [class.disabled]="auditPage.last">
            <button type="button"
                    class="page-link" 
                    (click)="nextPage()" 
                    [disabled]="auditPage.last"
                    aria-label="Página siguiente">
              <span class="material-symbols-outlined" aria-hidden="true">chevron_right</span>
            </button>
          </li>
        </ul>
      </nav>

      <!-- Información adicional de paginación -->
      <div class="pagination-summary">
        <small class="text-muted">
          Página {{auditPage.currentPage + 1}} de {{auditPage.totalPages}}
          <span class="mx-1">•</span>
          {{auditPage.totalElements}} registro{{auditPage.totalElements === 1 ? '' : 's'}} total{{auditPage.totalElements === 1 ? '' : 'es'}}
        </small>
      </div>
    </div>
  </section>
</div>
